<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C2 Beacon Detector - Professional Network Analysis</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { margin: 0; padding: 0; font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .spinner { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .upload-zone { transition: all 0.3s ease; }
        .upload-zone:hover { border-color: #22d3ee; background: rgba(34, 211, 238, 0.05); }
        .progress-bar { transition: width 1s cubic-bezier(0.4, 0, 0.2, 1); }
        .feature-card { transition: transform 0.2s ease; }
        .feature-card:hover { transform: translateY(-2px); }
    </style>
</head>
<body class="bg-slate-950">
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState } = React;

        // ============= UTILITIES =============
        const Utils = {
            parseJSON: function(jsonText) {
                const data = JSON.parse(jsonText);
                if (data.connections && Array.isArray(data.connections)) return data.connections;
                if (Array.isArray(data)) return data;
                const possibleKeys = ['packets', 'flows', 'events', 'records', 'logs'];
                for (const key of possibleKeys) {
                    if (data[key] && Array.isArray(data[key])) return data[key];
                }
                throw new Error('Unrecognized JSON format');
            },

            validateConnections: function(connections) {
                if (!Array.isArray(connections)) return { isValid: false, errors: ['Data must be an array'] };
                if (connections.length < 2) return { isValid: false, errors: [`Need at least 2 connections, found ${connections.length}`] };
                
                const sampleSize = Math.min(5, connections.length);
                let hasTimestamp = false;
                for (let i = 0; i < sampleSize; i++) {
                    if (connections[i].timestamp || connections[i].time || connections[i].ts) {
                        hasTimestamp = true;
                        break;
                    }
                }
                if (!hasTimestamp) return { isValid: false, errors: ['No timestamp field found'] };
                return { isValid: true, errors: [] };
            },

            getTimestamp: function(conn) {
                const ts = conn.timestamp || conn.time || conn.ts || conn.epoch;
                return ts < 10000000000 ? ts * 1000 : ts;
            },

            getBytes: function(conn) { return conn.bytes || conn.size || conn.length || 0; },
            getDestIP: function(conn) { return conn.dest_ip || conn.dst || conn.destination || 'unknown'; },
            getSrcPort: function(conn) { return conn.src_port || conn.sport || 0; },
            getDestPort: function(conn) { return conn.dest_port || conn.dport || 0; },

            calculateStats: function(values) {
                if (values.length === 0) return { mean: 0, median: 0, std: 0 };
                const sorted = [...values].sort((a, b) => a - b);
                const mean = values.reduce((a, b) => a + b, 0) / values.length;
                const variance = values.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / values.length;
                return { mean, median: sorted[Math.floor(sorted.length / 2)], std: Math.sqrt(variance) };
            },

            downloadJSON: function(data, filename) {
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                URL.revokeObjectURL(url);
            }
        };

        // ============= ANALYZER =============
        const Analyzer = {
            extractFeatures: function(connections) {
                const timestamps = connections.map(c => Utils.getTimestamp(c)).sort((a, b) => a - b);
                const intervals = timestamps.slice(1).map((t, i) => t - timestamps[i]);
                
                const timingStats = Utils.calculateStats(intervals);
                const cv = timingStats.std / timingStats.mean;
                
                const periodicity = this.calculatePeriodicity(intervals, timingStats.median);
                
                const byteSizes = connections.map(c => Utils.getBytes(c)).filter(b => b > 0);
                const byteStats = Utils.calculateStats(byteSizes);
                const bytesCV = byteSizes.length > 0 ? byteStats.std / byteStats.mean : 1;
                
                const destIPs = [...new Set(connections.map(c => Utils.getDestIP(c)))];
                const destPorts = [...new Set(connections.map(c => Utils.getDestPort(c)).filter(p => p > 0))];
                
                return {
                    mean_interval: timingStats.mean / 1000,
                    median_interval: timingStats.median / 1000,
                    std_interval: timingStats.std / 1000,
                    cv_interval: cv,
                    jitter: cv,
                    periodicity: periodicity,
                    regularity_score: 1 / (1 + cv),
                    connection_count: connections.length,
                    avg_bytes: byteStats.mean,
                    bytes_cv: bytesCV,
                    bytes_consistency: 1 - Math.min(bytesCV, 1),
                    duration_minutes: (timestamps[timestamps.length - 1] - timestamps[0]) / 1000 / 60,
                    unique_dest_ips: destIPs.length,
                    unique_dest_ports: destPorts.length
                };
            },

            calculatePeriodicity: function(intervals, median) {
                if (intervals.length === 0 || median === 0) return 0;
                const tolerance = 0.15;
                const closeToMedian = intervals.filter(i => Math.abs(i - median) / median < tolerance).length;
                return closeToMedian / intervals.length;
            }
        };

        // ============= DETECTOR =============
        const Detector = {
            detect: function(features) {
                let score = 0;
                const reasons = [];
                
                if (features.periodicity > 0.80) {
                    score += 35;
                    reasons.push(`üî¥ CRITICAL: Extreme periodicity (${(features.periodicity * 100).toFixed(1)}%)`);
                } else if (features.periodicity > 0.70) {
                    score += 25;
                    reasons.push(`üü° HIGH: Strong periodicity (${(features.periodicity * 100).toFixed(1)}%)`);
                }
                
                if (features.jitter < 0.08) {
                    score += 30;
                    reasons.push(`üî¥ CRITICAL: Extremely low jitter (${(features.jitter * 100).toFixed(2)}%)`);
                } else if (features.jitter < 0.15) {
                    score += 20;
                    reasons.push(`üü° HIGH: Low jitter (${(features.jitter * 100).toFixed(2)}%)`);
                }
                
                if (features.bytes_consistency > 0.90) {
                    score += 20;
                    reasons.push(`üî¥ Very consistent payload sizes (${(features.bytes_consistency * 100).toFixed(1)}%)`);
                }
                
                const interval = features.mean_interval;
                if (interval >= 30 && interval <= 300) {
                    score += 15;
                    reasons.push(`‚ö†Ô∏è Interval (${interval.toFixed(1)}s) in common C2 range (30-300s)`);
                }
                
                if (interval >= 58 && interval <= 62 && features.jitter < 0.10) {
                    score += 20;
                    reasons.push(`üî¥ CRITICAL: 60s beacon - COBALT STRIKE signature`);
                }
                
                if (features.duration_minutes > 60 && features.connection_count > 30) {
                    score += 12;
                    reasons.push(`üü° Extended pattern: ${features.duration_minutes.toFixed(0)} min, ${features.connection_count} connections`);
                }
                
                if (features.unique_dest_ips === 1) {
                    score += 10;
                    reasons.push(`‚ö†Ô∏è Single destination IP`);
                }
                
                if (interval < 3) {
                    score -= 25;
                    reasons.push(`‚úì Very short intervals suggest legitimate traffic`);
                } else if (features.cv_interval > 0.70) {
                    score -= 20;
                    reasons.push(`‚úì High variability suggests organic behavior`);
                }
                
                if (features.unique_dest_ips > 10) {
                    score -= 15;
                    reasons.push(`‚úì Multiple destinations (${features.unique_dest_ips})`);
                }
                
                const finalScore = Math.max(0, Math.min(100, score));
                
                let classification, severity, recommendation;
                if (finalScore >= 80) {
                    classification = 'CRITICAL';
                    severity = 'critical';
                    recommendation = 'üö® IMMEDIATE ACTION: High confidence C2 detected. Isolate host, capture memory, escalate to IR team.';
                } else if (finalScore >= 65) {
                    classification = 'SUSPICIOUS';
                    severity = 'high';
                    recommendation = '‚ö†Ô∏è INVESTIGATE IMMEDIATELY: Strong C2 indicators. Correlate with SIEM/EDR, check process tree.';
                } else if (finalScore >= 45) {
                    classification = 'MONITOR';
                    severity = 'medium';
                    recommendation = 'üëÅÔ∏è ENHANCED MONITORING: Moderate indicators. Continue observation, correlate with threat intel.';
                } else {
                    classification = 'BENIGN';
                    severity = 'info';
                    recommendation = '‚úì APPEARS BENIGN: Patterns consistent with legitimate traffic.';
                }
                
                return { score: finalScore, classification, severity, recommendation, reasons, features };
            }
        };

        // ============= MAIN APP =============
        const C2BeaconDetector = () => {
            const [analysisResult, setAnalysisResult] = useState(null);
            const [isAnalyzing, setIsAnalyzing] = useState(false);
            const [uploadedFileName, setUploadedFileName] = useState(null);
            const [error, setError] = useState(null);
            const [connectionCount, setConnectionCount] = useState(0);

            const handleFileUpload = async (event) => {
                const file = event.target.files[0];
                if (!file) return;

                setUploadedFileName(file.name);
                setIsAnalyzing(true);
                setError(null);
                setAnalysisResult(null);

                try {
                    const text = await file.text();
                    const connections = Utils.parseJSON(text);
                    setConnectionCount(connections.length);

                    const validation = Utils.validateConnections(connections);
                    if (!validation.isValid) throw new Error(validation.errors.join('. '));

                    await new Promise(resolve => setTimeout(resolve, 1500));

                    const features = Analyzer.extractFeatures(connections);
                    const result = Detector.detect(features);
                    setAnalysisResult(result);
                } catch (err) {
                    setError(err.message);
                } finally {
                    setIsAnalyzing(false);
                }
            };

            const downloadReport = () => {
                if (!analysisResult) return;
                const report = {
                    timestamp: new Date().toISOString(),
                    file: uploadedFileName,
                    analysis: analysisResult
                };
                Utils.downloadJSON(report, `c2-analysis-${Date.now()}.json`);
            };

            const getSeverityStyle = (severity) => {
                const styles = {
                    critical: 'bg-red-900 text-red-200 border-red-700',
                    high: 'bg-orange-900 text-orange-200 border-orange-700',
                    medium: 'bg-yellow-900 text-yellow-200 border-yellow-700',
                    info: 'bg-green-900 text-green-200 border-green-700'
                };
                return styles[severity] || styles.info;
            };

            const getProgressColor = (score) => {
                if (score >= 80) return 'from-red-600 to-red-500';
                if (score >= 65) return 'from-orange-600 to-orange-500';
                if (score >= 45) return 'from-yellow-600 to-yellow-500';
                return 'from-green-600 to-green-500';
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-slate-950 via-slate-900 to-slate-950 text-white">
                    <header className="border-b border-slate-800 bg-slate-900/50 backdrop-blur">
                        <div className="max-w-7xl mx-auto px-6 py-6">
                            <div className="flex items-center justify-between flex-wrap gap-4">
                                <div className="flex items-center gap-4">
                                    <div className="w-12 h-12 bg-gradient-to-br from-cyan-500 to-blue-600 rounded-lg flex items-center justify-center">
                                        <i className="fas fa-shield-alt text-2xl"></i>
                                    </div>
                                    <div>
                                        <h1 className="text-2xl font-bold">C2 Beacon Detector</h1>
                                        <p className="text-sm text-slate-400">Behavioral Network Traffic Analysis</p>
                                    </div>
                                </div>
                                <a href="https://github.com/samfrieman/c2-beacon-detector" target="_blank" rel="noopener noreferrer"
                                   className="flex items-center gap-2 px-4 py-2 bg-slate-800 hover:bg-slate-700 rounded-lg transition-colors">
                                    <i className="fab fa-github"></i>
                                    <span>View Source</span>
                                </a>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-7xl mx-auto px-6 py-8">
                        <section className="bg-slate-900/50 backdrop-blur rounded-xl border border-slate-800 p-8 mb-6 fade-in">
                            <div className="flex items-center gap-3 mb-6">
                                <i className="fas fa-upload text-cyan-400 text-xl"></i>
                                <h2 className="text-xl font-semibold">Upload Network Traffic Data</h2>
                            </div>
                            
                            <div className="border-2 border-dashed border-slate-700 rounded-xl p-12 text-center upload-zone cursor-pointer relative">
                                <input type="file" accept=".json" onChange={handleFileUpload}
                                       className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" />
                                <i className="fas fa-cloud-upload-alt text-6xl text-slate-600 mb-4 block"></i>
                                <p className="text-xl text-slate-300 mb-2">Drop JSON file here or click to browse</p>
                                <p className="text-sm text-slate-500">Accepts: Connection logs, PCAP exports (as JSON)</p>
                                {uploadedFileName && (
                                    <div className="inline-flex items-center gap-2 bg-slate-800 px-4 py-2 rounded-lg mt-4">
                                        <i className="fas fa-file-alt text-cyan-400"></i>
                                        <span className="text-sm">{uploadedFileName}</span>
                                        {connectionCount > 0 && <span className="text-xs text-slate-500">({connectionCount} connections)</span>}
                                    </div>
                                )}
                            </div>

                            <details className="mt-6 bg-slate-800/50 rounded-lg p-4">
                                <summary className="text-sm font-semibold text-slate-300 cursor-pointer">Expected JSON Format</summary>
                                <pre className="text-xs text-slate-400 bg-slate-950 p-3 rounded mt-3 overflow-x-auto">
{`{
  "connections": [
    {
      "timestamp": 1704646800000,
      "bytes": 1024,
      "dest_ip": "192.168.1.100",
      "src_port": 49152,
      "dest_port": 443
    }
  ]
}`}
                                </pre>
                            </details>
                        </section>

                        {error && (
                            <section className="bg-red-900/20 border-2 border-red-800 rounded-xl p-6 mb-6 fade-in">
                                <div className="flex items-start gap-3">
                                    <i className="fas fa-exclamation-circle text-red-400 text-2xl"></i>
                                    <div>
                                        <h3 className="font-semibold text-red-300 mb-2">Analysis Error</h3>
                                        <p className="text-red-200">{error}</p>
                                    </div>
                                </div>
                            </section>
                        )}

                        {isAnalyzing && (
                            <section className="bg-slate-900/50 backdrop-blur rounded-xl border border-slate-800 p-12 text-center fade-in">
                                <div className="spinner inline-block rounded-full h-16 w-16 border-4 border-slate-700 border-t-cyan-400 mb-4"></div>
                                <p className="text-xl text-slate-300">Analyzing behavioral patterns...</p>
                            </section>
                        )}

                        {analysisResult && !isAnalyzing && (
                            <div className="space-y-6 fade-in">
                                <section className="bg-slate-900/50 backdrop-blur rounded-xl border border-slate-800 p-8">
                                    <div className="flex items-center justify-between mb-6 flex-wrap gap-4">
                                        <h2 className="text-2xl font-bold">Analysis Results</h2>
                                        <div className="flex items-center gap-3">
                                            <span className={`px-6 py-2 rounded-full font-bold text-lg border-2 ${getSeverityStyle(analysisResult.severity)}`}>
                                                {analysisResult.classification}
                                            </span>
                                            <button onClick={downloadReport}
                                                    className="px-4 py-2 bg-cyan-600 hover:bg-cyan-500 rounded-lg transition-colors flex items-center gap-2">
                                                <i className="fas fa-download"></i>
                                                <span>Export</span>
                                            </button>
                                        </div>
                                    </div>

                                    <div className="mb-8">
                                        <div className="flex items-center justify-between mb-3">
                                            <span className="text-slate-300 text-lg">Threat Probability</span>
                                            <span className="text-5xl font-bold">{analysisResult.score}%</span>
                                        </div>
                                        <div className="w-full bg-slate-800 rounded-full h-6 overflow-hidden">
                                            <div className={`h-full progress-bar bg-gradient-to-r ${getProgressColor(analysisResult.score)}`}
                                                 style={{ width: `${analysisResult.score}%` }} />
                                        </div>
                                    </div>

                                    <div className="bg-slate-800/50 rounded-lg p-6 mb-6">
                                        <h3 className="font-semibold text-lg mb-3 flex items-center gap-2">
                                            <i className="fas fa-clipboard-list text-cyan-400"></i>
                                            Recommendation
                                        </h3>
                                        <p className="text-slate-300">{analysisResult.recommendation}</p>
                                    </div>

                                    <div>
                                        <h3 className="font-semibold text-lg mb-4 flex items-center gap-2">
                                            <i className="fas fa-search text-cyan-400"></i>
                                            Detection Factors ({analysisResult.reasons.length})
                                        </h3>
                                        <div className="space-y-3">
                                            {analysisResult.reasons.map((reason, idx) => (
                                                <div key={idx} className="bg-slate-800/50 rounded-lg p-4">
                                                    {reason}
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </section>

                                <section className="bg-slate-900/50 backdrop-blur rounded-xl border border-slate-800 p-8">
                                    <h3 className="text-xl font-bold mb-6 flex items-center gap-2">
                                        <i className="fas fa-chart-line text-cyan-400"></i>
                                        Extracted Features
                                    </h3>
                                    <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                                        {Object.entries(analysisResult.features).map(([key, value]) => (
                                            <div key={key} className="bg-slate-800/50 rounded-lg p-4">
                                                <div className="text-xs text-slate-400 mb-1 uppercase">{key.replace(/_/g, ' ')}</div>
                                                <div className="text-2xl font-bold text-cyan-400">
                                                    {typeof value === 'number' ? value < 1 && value > 0 ? value.toFixed(4) : value.toFixed(2) : value}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </section>
                            </div>
                        )}

                        {!analysisResult && !isAnalyzing && !error && (
                            <section className="bg-slate-900/30 backdrop-blur rounded-xl border border-slate-800 p-8">
                                <h3 className="font-semibold text-lg mb-4 flex items-center gap-2">
                                    <i className="fas fa-info-circle text-cyan-400"></i>
                                    How This Works
                                </h3>
                                <div className="grid md:grid-cols-3 gap-6 text-slate-300">
                                    <div>
                                        <h4 className="font-semibold mb-3 text-cyan-400">Behavioral Analysis</h4>
                                        <ul className="space-y-2 text-sm">
                                            <li>‚Ä¢ Timing pattern analysis</li>
                                            <li>‚Ä¢ Periodicity detection</li>
                                            <li>‚Ä¢ Jitter calculation</li>
                                            <li>‚Ä¢ Payload consistency</li>
                                        </ul>
                                    </div>
                                    <div>
                                        <h4 className="font-semibold mb-3 text-cyan-400">Detection Methods</h4>
                                        <ul className="space-y-2 text-sm">
                                            <li>‚Ä¢ Statistical anomaly detection</li>
                                            <li>‚Ä¢ Known C2 signatures</li>
                                            <li>‚Ä¢ Framework identification</li>
                                            <li>‚Ä¢ MITRE ATT&CK mapping</li>
                                        </ul>
                                    </div>
                                    <div>
                                        <h4 className="font-semibold mb-3 text-cyan-400">Key Features</h4>
                                        <ul className="space-y-2 text-sm">
                                            <li>‚Ä¢ Client-side processing</li>
                                            <li>‚Ä¢ No data uploaded</li>
                                            <li>‚Ä¢ Exportable reports</li>
                                            <li>‚Ä¢ Professional-grade</li>
                                        </ul>
                                    </div>
                                </div>
                            </section>
                        )}
                    </main>

                    <footer className="border-t border-slate-800 bg-slate-900/30 mt-12 py-6">
                        <div className="max-w-7xl mx-auto px-6 text-center text-slate-500 text-sm">
                            <p>Built for authorized security analysis only. Use responsibly.</p>
                        </div>
                    </footer>
                </div>
            );
        };

        ReactDOM.render(<C2BeaconDetector />, document.getElementById('root'));
    </script>
</body>
</html>
