<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C2 Beacon Detector - Professional Network Analysis</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #020617 0%, #0f172a 50%, #020617 100%);
            color: #f8fafc;
            min-height: 100vh;
        }

        .container { max-width: 1280px; margin: 0 auto; padding: 0 1.5rem; }
        
        /* Header */
        header {
            border-bottom: 1px solid #334155;
            background: rgba(15, 23, 42, 0.5);
            backdrop-filter: blur(10px);
        }
        
        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1.5rem 0;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .logo-section {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .logo {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #22d3ee, #3b82f6);
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }
        
        h1 { font-size: 1.5rem; font-weight: 700; }
        .subtitle { font-size: 0.875rem; color: #94a3b8; }
        
        .github-link {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: #1e293b;
            border-radius: 0.5rem;
            text-decoration: none;
            color: #f8fafc;
            transition: background 0.3s;
        }
        
        .github-link:hover { background: #334155; }
        
        /* Cards */
        .card {
            background: rgba(15, 23, 42, 0.5);
            backdrop-filter: blur(10px);
            border: 1px solid #334155;
            border-radius: 0.75rem;
            padding: 2rem;
            margin-bottom: 1.5rem;
        }
        
        .card-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
            font-size: 1.25rem;
            font-weight: 600;
        }
        
        .icon-cyan { color: #22d3ee; }
        
        /* Upload Zone */
        .upload-zone {
            border: 2px dashed #475569;
            border-radius: 0.75rem;
            padding: 3rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        
        .upload-zone:hover {
            border-color: #22d3ee;
            background: rgba(34, 211, 238, 0.05);
        }
        
        .upload-zone input[type="file"] {
            position: absolute;
            inset: 0;
            opacity: 0;
            cursor: pointer;
        }
        
        .upload-icon {
            font-size: 4rem;
            color: #475569;
            margin-bottom: 1rem;
        }
        
        .upload-text {
            font-size: 1.25rem;
            color: #cbd5e1;
            margin-bottom: 0.5rem;
        }
        
        .upload-subtext {
            font-size: 0.875rem;
            color: #64748b;
        }
        
        .file-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: #1e293b;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
        }
        
        /* Buttons */
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin-top: 1.5rem;
        }
        
        button {
            padding: 0.5rem 1rem;
            border: 1px solid;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-family: inherit;
        }
        
        .btn-red { background: rgba(127, 29, 29, 0.3); border-color: #b91c1c; color: #fca5a5; }
        .btn-red:hover { background: rgba(127, 29, 29, 0.5); }
        
        .btn-orange { background: rgba(124, 45, 18, 0.3); border-color: #c2410c; color: #fdba74; }
        .btn-orange:hover { background: rgba(124, 45, 18, 0.5); }
        
        .btn-green { background: rgba(20, 83, 45, 0.3); border-color: #15803d; color: #86efac; }
        .btn-green:hover { background: rgba(20, 83, 45, 0.5); }
        
        .btn-cyan { background: #0e7490; border-color: #0e7490; color: white; }
        .btn-cyan:hover { background: #06b6d4; }
        
        /* Details */
        details {
            background: rgba(30, 41, 59, 0.5);
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 1.5rem;
        }
        
        summary {
            font-size: 0.875rem;
            font-weight: 600;
            color: #cbd5e1;
            cursor: pointer;
        }
        
        pre {
            font-size: 0.75rem;
            color: #94a3b8;
            background: #020617;
            padding: 0.75rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            margin-top: 0.75rem;
        }
        
        /* Error */
        .error-card {
            background: rgba(127, 29, 29, 0.2);
            border: 2px solid #b91c1c;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            display: flex;
            gap: 0.75rem;
        }
        
        .error-icon { color: #f87171; font-size: 1.5rem; }
        .error-title { font-weight: 600; color: #fca5a5; margin-bottom: 0.5rem; }
        .error-text { color: #fecaca; }
        
        /* Loading */
        .loading-card {
            background: rgba(15, 23, 42, 0.5);
            border: 1px solid #334155;
            border-radius: 0.75rem;
            padding: 3rem;
            text-align: center;
        }
        
        .spinner {
            display: inline-block;
            width: 4rem;
            height: 4rem;
            border: 4px solid #475569;
            border-top-color: #22d3ee;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Results */
        .result-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .result-header h2 { font-size: 1.5rem; font-weight: 700; }
        
        .badge-group {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .badge {
            padding: 0.5rem 1.5rem;
            border: 2px solid;
            border-radius: 9999px;
            font-weight: 700;
            font-size: 1.125rem;
        }
        
        .badge-critical { background: #7f1d1d; color: #fecaca; border-color: #b91c1c; }
        .badge-high { background: #7c2d12; color: #fed7aa; border-color: #c2410c; }
        .badge-medium { background: #713f12; color: #fef08a; border-color: #ca8a04; }
        .badge-info { background: #14532d; color: #bbf7d0; border-color: #15803d; }
        
        /* Progress Bar */
        .progress-section { margin-bottom: 2rem; }
        
        .progress-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }
        
        .progress-label { font-size: 1.125rem; color: #cbd5e1; }
        .progress-value { font-size: 3rem; font-weight: 700; }
        
        .progress-bg {
            width: 100%;
            height: 1.5rem;
            background: #1e293b;
            border-radius: 9999px;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            transition: width 1s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .progress-critical { background: linear-gradient(to right, #dc2626, #ef4444); }
        .progress-high { background: linear-gradient(to right, #ea580c, #f97316); }
        .progress-medium { background: linear-gradient(to right, #ca8a04, #eab308); }
        .progress-low { background: linear-gradient(to right, #16a34a, #22c55e); }
        
        /* Recommendation Box */
        .recommendation {
            background: rgba(30, 41, 59, 0.5);
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .recommendation h3 {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
        }
        
        .recommendation p { color: #cbd5e1; line-height: 1.6; }
        
        /* Detection Factors */
        .factors-list { margin-top: 1rem; }
        
        .factor-item {
            background: rgba(30, 41, 59, 0.5);
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 0.75rem;
            color: #cbd5e1;
        }
        
        /* Framework Cards */
        .grid { display: grid; gap: 1rem; }
        .grid-2 { grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); }
        
        .framework-card {
            background: rgba(30, 41, 59, 0.5);
            border-radius: 0.5rem;
            padding: 1rem;
        }
        
        .framework-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }
        
        .framework-name { font-weight: 700; font-size: 1.125rem; }
        
        .confidence-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
        }
        
        .confidence-high { background: #7f1d1d; color: #fecaca; }
        .confidence-medium { background: #713f12; color: #fef08a; }
        .confidence-low { background: #1e3a8a; color: #bfdbfe; }
        
        .framework-reason { font-size: 0.875rem; color: #94a3b8; }
        
        /* Features Grid */
        .grid-4 { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); }
        
        .feature-card {
            background: rgba(30, 41, 59, 0.5);
            border-radius: 0.5rem;
            padding: 1rem;
        }
        
        .feature-label {
            font-size: 0.75rem;
            color: #94a3b8;
            text-transform: uppercase;
            margin-bottom: 0.25rem;
        }
        
        .feature-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #22d3ee;
        }
        
        /* Info Section */
        .info-grid { display: grid; gap: 1.5rem; }
        
        @media (min-width: 768px) {
            .info-grid { grid-template-columns: repeat(3, 1fr); }
        }
        
        .info-section h4 {
            font-weight: 600;
            color: #22d3ee;
            margin-bottom: 0.75rem;
        }
        
        .info-section ul {
            list-style: none;
            font-size: 0.875rem;
        }
        
        .info-section li {
            color: #cbd5e1;
            margin-bottom: 0.5rem;
        }
        
        /* Footer */
        footer {
            border-top: 1px solid #334155;
            background: rgba(15, 23, 42, 0.3);
            margin-top: 3rem;
            padding: 1.5rem 0;
            text-align: center;
            color: #64748b;
            font-size: 0.875rem;
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .hidden { display: none; }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo-section">
                    <div class="logo">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <div>
                        <h1>C2 Beacon Detector</h1>
                        <div class="subtitle">Behavioral Network Traffic Analysis</div>
                    </div>
                </div>
                <a href="https://github.com/samfrieman/c2-beacon-detector" class="github-link" target="_blank">
                    <i class="fab fa-github"></i>
                    <span>View Source</span>
                </a>
            </div>
        </div>
    </header>

    <main class="container" style="padding-top: 2rem; padding-bottom: 2rem;">
        <!-- Upload Section -->
        <div class="card">
            <div class="card-header">
                <i class="fas fa-upload icon-cyan"></i>
                <span>Upload Network Traffic Data</span>
            </div>
            
            <div class="upload-zone" id="uploadZone">
                <input type="file" accept=".json" id="fileInput">
                <i class="fas fa-cloud-upload-alt upload-icon"></i>
                <p class="upload-text">Drop JSON file here or click to browse</p>
                <p class="upload-subtext">Accepts: Connection logs, PCAP exports (as JSON)</p>
                <div id="fileBadge" class="hidden"></div>
            </div>

            <div class="button-group">
                <span style="font-size: 0.875rem; color: #94a3b8; align-self: center;">Try with sample data:</span>
                <button class="btn-red" onclick="analyzeSample('cobalt-strike')">
                    <i class="fas fa-bug"></i> Cobalt Strike Sample
                </button>
                <button class="btn-orange" onclick="analyzeSample('metasploit')">
                    <i class="fas fa-virus"></i> Metasploit Sample
                </button>
                <button class="btn-green" onclick="analyzeSample('benign')">
                    <i class="fas fa-check"></i> Benign Traffic Sample
                </button>
            </div>

            <details>
                <summary>Expected JSON Format</summary>
                <pre>{
  "connections": [
    {
      "timestamp": 1704646800000,
      "bytes": 1024,
      "dest_ip": "192.168.1.100",
      "src_port": 49152,
      "dest_port": 443
    }
  ]
}</pre>
            </details>
        </div>

        <!-- Error Section -->
        <div id="errorSection" class="hidden"></div>

        <!-- Loading Section -->
        <div id="loadingSection" class="hidden">
            <div class="loading-card fade-in">
                <div class="spinner"></div>
                <p style="font-size: 1.25rem; color: #cbd5e1;">Analyzing behavioral patterns...</p>
            </div>
        </div>

        <!-- Results Section -->
        <div id="resultsSection" class="hidden"></div>

        <!-- Info Section -->
        <div id="infoSection" class="card">
            <div class="card-header">
                <i class="fas fa-info-circle icon-cyan"></i>
                <span>How This Works</span>
            </div>
            <div class="info-grid">
                <div class="info-section">
                    <h4>Behavioral Analysis</h4>
                    <ul>
                        <li>‚Ä¢ Timing pattern analysis</li>
                        <li>‚Ä¢ Periodicity detection</li>
                        <li>‚Ä¢ Jitter calculation</li>
                        <li>‚Ä¢ Payload consistency</li>
                    </ul>
                </div>
                <div class="info-section">
                    <h4>Detection Methods</h4>
                    <ul>
                        <li>‚Ä¢ Statistical anomaly detection</li>
                        <li>‚Ä¢ Known C2 signatures</li>
                        <li>‚Ä¢ Framework identification</li>
                        <li>‚Ä¢ MITRE ATT&CK concepts</li>
                    </ul>
                </div>
                <div class="info-section">
                    <h4>Key Features</h4>
                    <ul>
                        <li>‚Ä¢ Client-side processing</li>
                        <li>‚Ä¢ No data uploaded</li>
                        <li>‚Ä¢ Exportable reports</li>
                        <li>‚Ä¢ Professional-grade</li>
                    </ul>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <div class="container">
            <p>Built for authorized security analysis only. Use responsibly.</p>
        </div>
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    
    <script>
        // Utility Functions
        const Utils = {
            parseJSON(jsonText) {
                const data = JSON.parse(jsonText);
                if (data.connections && Array.isArray(data.connections)) return data.connections;
                if (Array.isArray(data)) return data;
                const possibleKeys = ['packets', 'flows', 'events', 'records', 'logs'];
                for (const key of possibleKeys) {
                    if (data[key] && Array.isArray(data[key])) return data[key];
                }
                throw new Error('Unrecognized JSON format');
            },

            validateConnections(connections) {
                if (!Array.isArray(connections)) return { isValid: false, errors: ['Data must be an array'] };
                if (connections.length < 2) return { isValid: false, errors: [`Need at least 2 connections, found ${connections.length}`] };
                
                const sampleSize = Math.min(5, connections.length);
                let hasTimestamp = false;
                for (let i = 0; i < sampleSize; i++) {
                    if (connections[i].timestamp || connections[i].time || connections[i].ts) {
                        hasTimestamp = true;
                        break;
                    }
                }
                if (!hasTimestamp) return { isValid: false, errors: ['No timestamp field found'] };
                return { isValid: true, errors: [] };
            },

            getTimestamp(conn) {
                const ts = conn.timestamp || conn.time || conn.ts || conn.epoch;
                if (!ts) throw new Error('No timestamp found');
                return ts < 10000000000 ? ts * 1000 : ts;
            },

            getBytes(conn) { return conn.bytes || conn.size || conn.length || 0; },
            getDestIP(conn) { return conn.dest_ip || conn.dst || conn.destination || 'unknown'; },
            getSrcPort(conn) { return conn.src_port || conn.sport || 0; },
            getDestPort(conn) { return conn.dest_port || conn.dport || 0; },

            calculateStats(values) {
                if (values.length === 0) return { mean: 0, median: 0, std: 0, min: 0, max: 0 };
                const sorted = [...values].sort((a, b) => a - b);
                const mean = values.reduce((a, b) => a + b, 0) / values.length;
                const variance = values.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / values.length;
                return {
                    mean,
                    median: sorted[Math.floor(sorted.length / 2)],
                    std: Math.sqrt(variance),
                    min: sorted[0],
                    max: sorted[sorted.length - 1]
                };
            },

            formatDuration(minutes) {
                if (minutes < 1) return `${Math.round(minutes * 60)} seconds`;
                if (minutes < 60) return `${Math.round(minutes)} minutes`;
                const hours = Math.floor(minutes / 60);
                const mins = Math.round(minutes % 60);
                return `${hours}h ${mins}m`;
            },

            downloadJSON(data, filename) {
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                URL.revokeObjectURL(url);
            },

            generateSampleData(beaconType) {
                const now = Date.now();
                const connections = [];
                let interval, jitter, count;

                if (beaconType === 'cobalt-strike') {
                    interval = 60000;
                    jitter = 0.05;
                    count = 50;
                } else if (beaconType === 'metasploit') {
                    interval = 120000;
                    jitter = 0.10;
                    count = 40;
                } else {
                    interval = 2000;
                    jitter = 0.60;
                    count = 100;
                }

                for (let i = 0; i < count; i++) {
                    const variance = interval * jitter * (Math.random() - 0.5) * 2;
                    const timestamp = now + (i * interval) + variance;
                    const bytes = beaconType === 'benign' ?
                        Math.floor(Math.random() * 5000) + 500 :
                        Math.floor(1024 + (Math.random() * 100));

                    connections.push({
                        timestamp: timestamp,
                        bytes: bytes,
                        dest_ip: '192.168.1.100',
                        src_port: 49152 + i,
                        dest_port: 443
                    });
                }

                return connections;
            }
        };

        // Analyzer
        const Analyzer = {
            extractFeatures(connections) {
                const timestamps = connections.map(c => Utils.getTimestamp(c)).sort((a, b) => a - b);
                const intervals = timestamps.slice(1).map((t, i) => t - timestamps[i]);

                const timingStats = Utils.calculateStats(intervals);
                const cv = timingStats.mean > 0 ? timingStats.std / timingStats.mean : 0;

                const periodicity = this.calculatePeriodicity(intervals, timingStats.median);

                const byteSizes = connections.map(c => Utils.getBytes(c)).filter(b => b > 0);
                const byteStats = Utils.calculateStats(byteSizes);
                const bytesCV = byteSizes.length > 0 && byteStats.mean > 0 ? byteStats.std / byteStats.mean : 1;

                const destIPs = [...new Set(connections.map(c => Utils.getDestIP(c)))];
                const destPorts = [...new Set(connections.map(c => Utils.getDestPort(c)).filter(p => p > 0))];

                const durationMs = timestamps[timestamps.length - 1] - timestamps[0];

                return {
                    mean_interval: timingStats.mean / 1000,
                    median_interval: timingStats.median / 1000,
                    std_interval: timingStats.std / 1000,
                    min_interval: timingStats.min / 1000,
                    max_interval: timingStats.max / 1000,
                    cv_interval: cv,
                    jitter: cv,
                    periodicity: periodicity,
                    regularity_score: cv > 0 ? 1 / (1 + cv) : 0,
                    connection_count: connections.length,
                    avg_bytes: byteStats.mean,
                    median_bytes: byteStats.median,
                    bytes_cv: bytesCV,
                    bytes_consistency: 1 - Math.min(bytesCV, 1),
                    duration_minutes: durationMs / 1000 / 60,
                    unique_dest_ips: destIPs.length,
                    unique_dest_ports: destPorts.length,
                    connections_per_minute: connections.length / Math.max(durationMs / 1000 / 60, 1)
                };
            },

            calculatePeriodicity(intervals, median) {
                if (intervals.length === 0 || median === 0) return 0;
                const tolerance = 0.15;
                const closeToMedian = intervals.filter(i => Math.abs(i - median) / median < tolerance).length;
                return closeToMedian / intervals.length;
            },

            identifyFramework(features) {
                const frameworks = [];
                const interval = features.mean_interval;

                if (interval >= 55 && interval <= 65 && features.jitter < 0.10) {
                    frameworks.push({
                        name: 'Cobalt Strike',
                        confidence: 'High',
                        reason: '60-second beacon interval with low jitter'
                    });
                }

                if (interval >= 110 && interval <= 130 && features.jitter < 0.15) {
                    frameworks.push({
                        name: 'Metasploit/Meterpreter',
                        confidence: 'Medium',
                        reason: '120-second beacon pattern'
                    });
                }

                if (interval >= 4 && interval <= 12 && features.periodicity > 0.6) {
                    frameworks.push({
                        name: 'PowerShell Empire',
                        confidence: 'Medium',
                        reason: 'Short interval with moderate periodicity'
                    });
                }

                return frameworks.length > 0 ? frameworks : [{
                    name: 'Unknown/Custom',
                    confidence: 'N/A',
                    reason: 'Does not match known framework signatures'
                }];
            }
        };

        // Detector
        const Detector = {
            detect(features) {
                let score = 0;
                const reasons = [];
                const technicalDetails = [];

                if (features.periodicity > 0.80) {
                    score += 35;
                    reasons.push(`üî¥ CRITICAL: Extreme periodicity (${(features.periodicity * 100).toFixed(1)}%)`);
                    technicalDetails.push(`Periodicity: ${features.periodicity.toFixed(3)} (threshold: >0.80)`);
                } else if (features.periodicity > 0.70) {
                    score += 25;
                    reasons.push(`üü° HIGH: Strong periodicity (${(features.periodicity * 100).toFixed(1)}%)`);
                } else if (features.periodicity > 0.60) {
                    score += 15;
                    reasons.push(`‚ö†Ô∏è MODERATE: Notable periodicity (${(features.periodicity * 100).toFixed(1)}%)`);
                }

                if (features.jitter < 0.08) {
                    score += 30;
                    reasons.push(`üî¥ CRITICAL: Extremely low jitter (${(features.jitter * 100).toFixed(2)}%)`);
                    technicalDetails.push(`Jitter (CV): ${features.jitter.toFixed(4)} (threshold: <0.08)`);
                } else if (features.jitter < 0.15) {
                    score += 20;
                    reasons.push(`üü° HIGH: Low jitter (${(features.jitter * 100).toFixed(2)}%)`);
                } else if (features.jitter < 0.25) {
                    score += 10;
                    reasons.push(`‚ö†Ô∏è MODERATE: Consistent timing (${(features.jitter * 100).toFixed(2)}%)`);
                }

                if (features.bytes_consistency > 0.90) {
                    score += 20;
                    reasons.push(`üî¥ Very consistent payload sizes (${(features.bytes_consistency * 100).toFixed(1)}%)`);
                } else if (features.bytes_consistency > 0.80) {
                    score += 15;
                    reasons.push(`üü° Consistent payloads (${(features.bytes_consistency * 100).toFixed(1)}%)`);
                }

                const interval = features.mean_interval;
                if (interval >= 30 && interval <= 300) {
                    score += 15;
                    reasons.push(`‚ö†Ô∏è Interval (${interval.toFixed(1)}s) in common C2 range (30-300s)`);
                }

                if (interval >= 58 && interval <= 62 && features.jitter < 0.10) {
                    score += 20;
                    reasons.push(`üî¥ CRITICAL: 60s beacon - COBALT STRIKE signature`);
                }

                if (interval >= 115 && interval <= 125 && features.jitter < 0.12) {
                    score += 18;
                    reasons.push(`üî¥ HIGH: 120s beacon - METASPLOIT signature`);
                }

                if (features.duration_minutes > 120 && features.connection_count > 50) {
                    score += 15;
                    reasons.push(`üî¥ Sustained beaconing: ${Utils.formatDuration(features.duration_minutes)}`);
                } else if (features.duration_minutes > 60 && features.connection_count > 30) {
                    score += 12;
                    reasons.push(`üü° Extended pattern: ${Utils.formatDuration(features.duration_minutes)}`);
                }

                if (features.unique_dest_ips === 1) {
                    score += 10;
                    reasons.push(`‚ö†Ô∏è Single destination IP`);
                }

                if (interval < 3) {
                    score -= 25;
                    reasons.push(`‚úì Very short intervals suggest legitimate traffic`);
                } else if (features.cv_interval > 0.70) {
                    score -= 20;
                    reasons.push(`‚úì High variability suggests organic behavior`);
                }

                if (features.unique_dest_ips > 10) {
                    score -= 15;
                    reasons.push(`‚úì Multiple destinations (${features.unique_dest_ips})`);
                }

                const finalScore = Math.max(0, Math.min(100, score));

                let classification, severity, recommendation;
                if (finalScore >= 80) {
                    classification = 'CRITICAL';
                    severity = 'critical';
                    recommendation = 'üö® IMMEDIATE ACTION: High confidence C2 detected. Isolate host, capture memory, escalate to IR team.';
                } else if (finalScore >= 65) {
                    classification = 'SUSPICIOUS';
                    severity = 'high';
                    recommendation = '‚ö†Ô∏è INVESTIGATE IMMEDIATELY: Strong C2 indicators. Correlate with SIEM/EDR, check process tree.';
                } else if (finalScore >= 45) {
                    classification = 'MONITOR';
                    severity = 'medium';
                    recommendation = 'üëÅÔ∏è ENHANCED MONITORING: Moderate indicators. Continue observation, correlate with threat intel.';
                } else {
                    classification = 'BENIGN';
                    severity = 'info';
                    recommendation = '‚úì APPEARS BENIGN: Patterns consistent with legitimate traffic.';
                }

                const frameworks = Analyzer.identifyFramework(features);

                return {
                    score: finalScore,
                    classification,
                    severity,
                    recommendation,
                    reasons,
                    technicalDetails,
                    features,
                    identifiedFrameworks: frameworks,
                    timestamp: new Date().toISOString()
                };
            }
        };

        // UI Controller
        let currentAnalysis = null;
        let currentFileName = null;

        function showError(message) {
            const errorSection = document.getElementById('errorSection');
            errorSection.innerHTML = `
                <div class="error-card fade-in">
                    <i class="fas fa-exclamation-circle error-icon"></i>
                    <div>
                        <h3 class="error-title">Analysis Error</h3>
                        <p class="error-text">${message}</p>
                    </div>
                </div>
            `;
            errorSection.classList.remove('hidden');
        }

        function hideError() {
            document.getElementById('errorSection').classList.add('hidden');
        }

        function showLoading() {
            document.getElementById('loadingSection').classList.remove('hidden');
            document.getElementById('resultsSection').classList.add('hidden');
            document.getElementById('infoSection').classList.add('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingSection').classList.add('hidden');
        }

        function showResults(result) {
            hideLoading();
            document.getElementById('infoSection').classList.add('hidden');
            
            const resultsSection = document.getElementById('resultsSection');
            
            const badgeClass = {
                'critical': 'badge-critical',
                'high': 'badge-high',
                'medium': 'badge-medium',
                'info': 'badge-info'
            }[result.severity];

            const progressClass = {
                'critical': 'progress-critical',
                'high': 'progress-high',
                'medium': 'progress-medium',
                'info': 'progress-low'
            }[result.severity];

            let frameworksHTML = '';
            if (result.identifiedFrameworks && result.identifiedFrameworks.length > 0) {
                const confidenceClass = (conf) => {
                    if (conf === 'High') return 'confidence-high';
                    if (conf === 'Medium') return 'confidence-medium';
                    return 'confidence-low';
                };

                frameworksHTML = `
                    <div class="card fade-in">
                        <div class="card-header">
                            <i class="fas fa-fingerprint icon-cyan"></i>
                            <span>Potential C2 Frameworks</span>
                        </div>
                        <div class="grid grid-2">
                            ${result.identifiedFrameworks.map(fw => `
                                <div class="framework-card">
                                    <div class="framework-header">
                                        <span class="framework-name">${fw.name}</span>
                                        <span class="confidence-badge ${confidenceClass(fw.confidence)}">${fw.confidence}</span>
                                    </div>
                                    <p class="framework-reason">${fw.reason}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            let technicalHTML = '';
            if (result.technicalDetails && result.technicalDetails.length > 0) {
                technicalHTML = `
                    <details style="margin-top: 1.5rem;">
                        <summary>Technical Details (${result.technicalDetails.length})</summary>
                        <div style="margin-top: 0.75rem;">
                            ${result.technicalDetails.map(detail => `
                                <p style="font-size: 0.75rem; color: #64748b; font-family: monospace; margin-bottom: 0.25rem;">‚Ä¢ ${detail}</p>
                            `).join('')}
                        </div>
                    </details>
                `;
            }

            resultsSection.innerHTML = `
                <div class="card fade-in">
                    <div class="result-header">
                        <h2>Analysis Results</h2>
                        <div class="badge-group">
                            <span class="badge ${badgeClass}">${result.classification}</span>
                            <button class="btn-cyan" onclick="downloadReport()">
                                <i class="fas fa-download"></i>
                                <span>Export</span>
                            </button>
                        </div>
                    </div>

                    <div class="progress-section">
                        <div class="progress-header">
                            <span class="progress-label">Threat Probability</span>
                            <span class="progress-value">${result.score}%</span>
                        </div>
                        <div class="progress-bg">
                            <div class="progress-bar ${progressClass}" style="width: ${result.score}%"></div>
                        </div>
                    </div>

                    <div class="recommendation">
                        <h3>
                            <i class="fas fa-clipboard-list icon-cyan"></i>
                            Recommendation
                        </h3>
                        <p>${result.recommendation}</p>
                    </div>

                    <div>
                        <h3 style="display: flex; align-items: center; gap: 0.5rem; font-size: 1.125rem; font-weight: 600; margin-bottom: 1rem;">
                            <i class="fas fa-search icon-cyan"></i>
                            Detection Factors (${result.reasons.length})
                        </h3>
                        <div class="factors-list">
                            ${result.reasons.map(reason => `
                                <div class="factor-item">${reason}</div>
                            `).join('')}
                        </div>
                    </div>

                    ${technicalHTML}
                </div>

                ${frameworksHTML}

                <div class="card fade-in">
                    <div class="card-header">
                        <i class="fas fa-chart-line icon-cyan"></i>
                        <span>Extracted Features</span>
                    </div>
                    <div class="grid grid-4">
                        ${Object.entries(result.features).map(([key, value]) => `
                            <div class="feature-card">
                                <div class="feature-label">${key.replace(/_/g, ' ')}</div>
                                <div class="feature-value">
                                    ${typeof value === 'number' ? 
                                        (value < 1 && value > 0 ? value.toFixed(4) : value.toFixed(2)) : 
                                        value}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;

            resultsSection.classList.remove('hidden');
        }

        async function analyzeConnections(connections, fileName) {
            currentFileName = fileName;
            hideError();
            showLoading();

            try {
                const validation = Utils.validateConnections(connections);
                if (!validation.isValid) {
                    throw new Error(validation.errors.join('. '));
                }

                // Update file badge
                const fileBadge = document.getElementById('fileBadge');
                fileBadge.innerHTML = `
                    <i class="fas fa-file-alt icon-cyan"></i>
                    <span style="font-size: 0.875rem;">${fileName}</span>
                    <span style="font-size: 0.75rem; color: #64748b;">(${connections.length} connections)</span>
                `;
                fileBadge.classList.remove('hidden');

                // Simulate processing time
                await new Promise(resolve => setTimeout(resolve, 1500));

                const features = Analyzer.extractFeatures(connections);
                const result = Detector.detect(features);
                currentAnalysis = result;

                showResults(result);
            } catch (err) {
                hideLoading();
                showError(err.message);
                document.getElementById('infoSection').classList.remove('hidden');
            }
        }

        function analyzeSample(type) {
            const connections = Utils.generateSampleData(type);
            const fileName = `Sample: ${type}`;
            analyzeConnections(connections, fileName);
        }

        function downloadReport() {
            if (!currentAnalysis) return;

            const report = {
                metadata: {
                    tool: 'C2 Beacon Detector',
                    version: '1.0.0',
                    timestamp: new Date().toISOString(),
                    analyzed_file: currentFileName
                },
                analysis: currentAnalysis
            };

            Utils.downloadJSON(report, `c2-analysis-${Date.now()}.json`);
        }

        // File upload handler
        document.getElementById('fileInput').addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) return;

            hideError();

            try {
                const text = await file.text();
                const connections = Utils.parseJSON(text);
                analyzeConnections(connections, file.name);
            } catch (err) {
                showError(err.message);
            }
        });
    </script>
</body>
</html>
